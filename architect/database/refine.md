## 数据库优化技术

### 1.集中式数据库优化

#### 1.1 反规范化技术

数据库中的数据反范式某种意义上来说就是一种<mark>以空间换时间</mark>的手段。

数据规范化优点是减少了数据冗余，节约了存储空间，相应逻辑和物理的I/O次数减少，同时加快了增、删、改的速度。但是对完全规范的数据库查询，通常需要更多的连接操作，从而影响查询速度。因此，有时为了提高某些查询或应用的性能而破坏规范规则，即反规范化（非规范化处理）。

**常见的反规范化技术包括：**

* **增加冗余列：**为避免连表查询带来的性能损耗，直接在多张表存储相同的属性字段；
* **增加派生列：**为加快查询、响应速度，增加列存储派生属性，避免了查询时计算；
* **重新组表：**将多张表连接出的结果从新组表，避免连表查询；
* **水平分割表：**按记录进行分割，把数据放到多张独立的表中存储，当数据规模很大、表中的数据相对独立或数据归档时使用；
* **垂直分割表：**对表进行分割，挑选查询频率较高的列与主键重新组表；

**反规范化设计的优缺点：**

* **优点：**避免了进行表之间的连接操作，可以提高数据操作的性能。
* **缺点：**数据重复存储，浪费磁盘空间，同时也会产生数据不一致问题

**反规范化设计问题的解决方案：**
1. **触发器：**创建触发器，当改变相关列的值时，自动触发某些相关值的更新，不推荐使用
2. **事务保证机制：**更新数据时，放在一个事务当中进行，要成功全成功，推荐使用；
3. **应用保证：**适用于异构数据库；
4. **批处理脚本：**定期运行脚本同步数据，适用于数据一致性宽松的业务

### 2.分布式数据库优化

#### 2.1 主从复制

建立一个和主数据库一样的数据库环境当作从数据库，这样做的好处是：

* 数据的热备。有了后备数据库，当主数据库故障后，可以切换到从数据库继续工作，提高了系统可用性；
* 读写分离。当业务量越来越大，单机无法满足。此时从库提供读访问，可减轻主库压力；

**主从复制的具体过程如下：**

<img src="/assets/imgs/architect/database/主从复制.png">
    
1. 从库启动一个I/O线程向主库发送binlog同步请求；
2. 主库的dump线程读取binlog信息，并将其发送给从库的I/O线程处理；
3. 从库的I/O线程接收到binlog日志信息，将其写入relaylog；
4. 从库的SQL线程读取relaylog中的信息，将数据库的更新事件在存储引擎中执行。

**binlog日志记录的三种模式**

1. **基于SQL的语句**。binlog记录每一条更新语句，进而同步到从库的relaylog中，回放执行。这种模式应尽量避免SQL中含有变量，函数等会造成数据不一致的情况。

2. **基于行**。只记录更新前和更新后的数据，缺点是1条数据更新1万次，就得记录1万次更新数据。

3. **混合记录**。有绑定本地特性可能造成数据不一致的情况时采用基于行的渎职，否则自动采用基于SQL的复制。

**主从同步的模式：**

|同步模式|解释|一致性|可用性|典型框架/系统|
|-|-|-|-|-|
|全同步技术|当主库执行完一个事务，所有的从库都执行了该事务才返回给客户端|强|弱|MySQL|
|半同步技术|主库只等待至少一个从库节点将Binlog保存到Relaylog中|较强|较弱|MySQL、Zookeeper、CloudSQLServer、Redis、Oracle、Etcd等|
|异步复制技术|主库完成食物后立即将结果返回给客户端，不关心从库是否处理完|弱|强|MySQL、Redis、Oracle|

#### 2.2 读写分离
设置不同的主/从数据库分别负责不同的操作，让主库负责写操作、从库负责读操作。

<img src="/assets/imgs/architect/database/数据库读写分离.png">

#### 2.3 分表
分表，也叫分片，将一张大表分成若干个小表，业务可以同时访问多个表，提高并发能力。 

<img src="/assets/imgs/architect/database/分表.png">

#### 2.4 分库
将原本放在一个实例上的数据表，分开存放带不同的实例上。有利于差异化管理。比如：将订单数据、商品数据、用户数据分别存储在不同的数据库实例上。

分库分表为了不影响业务代码的实现方式，可以引入数据访问中间件来解决。

<img src="/assets/imgs/architect/database/数据访问代理png.png">