## 数据库缓存edis

Redis是当前使用最广泛的NoSQL，基于内存，性能十分优越，可以支持每秒十几万此的读/写操作。并且还支持集群、分布式、主从同步等配置，原则上可以无限扩展。

### 1.数据类型

<img src="/assets/imgs/architect/database/redis-types.png">

### 2.数据一致性

Redis作为缓存时，由于数据同时要在主存缓存中进行存储，必然会存在数据一致性的问题。当读取数据时步骤如下：
1. 根据key访问缓存；
2. 缓存命中直接返回；
3. 缓存Miss，查询主存；
4. 将查询到主存中的数据重新写入缓存；
5. 最终返回结果。
更新数据时则要按一下步骤进行：
1. 根据Key值写入数据库；
2. 写入成功后更新缓存；
3. 成功返回。

### 3.淘汰策略

1. 惰性删除：查询时对key进行检测，过期则删除。如果一致未被访问则常驻内存；
2. 定期删除：每隔一段时间做一次检查，删除过期的key。但不能对所有额key进行此操作，只会随机取一些key做检查；
3. 内存淘汰机制：上述两种方式还是会存在key没有被删除的场景，因此需要内存淘汰策略做补充兜底，具体有以下几种：
    * 最近最少使用（volatile-lru）
    * 最不经常使用（volatile-lfu）
    * 随机淘汰（volatile-random）
    * 生存时间淘汰（volatile-ttl）
    * 所有key最近最少使用（allkeys-lru）
    * 所有key最不经常使用（allkeys-lfu）
    * 所有key随机淘汰（allkeys-random）

### 4.持久化

Redis时基于内存的，一旦服务器宕机，内存中的数据将直接丢失。如果恢复是从数据库中再次读取，可能会造成“缓存穿透”问题。所以，Redis实现持久化时比较重要的。

Redis的持久化策略有以下两种：

<img src="/assets/imgs/architect/database/持久化策略.png">

### 5.缓存三大问题

#### 5.1 缓存穿透

* **现象：**大量的请求访问没有被缓存的key，导致请求直接打向数据库；
* **原因：**恶意攻击，使用大量无效的key来访问服务器。例如使用无效的登录名，发送大量的认证请求；
* **解决方案：**
    1. 限制访问频率，如果时来源较少的IP，可拉入黑名单；
    2. 提前检查key的合法性（如果可以），不合法直接拒绝服务；
    3. 使用布隆过滤器，作为缓存和数据库之间的过滤屏障；布隆过滤器的特征就是：在不一定在，不在那是真不在；

#### 5.2 缓存雪崩

* **现象：**大量缓存key同时失效；
* **原因：**Redis宕机，网络抖动，key的过期时间相同；
* **解决方案：**
    1. 使用主从复制提高可用性，使用cluster集群方案降低故障影响范围；
    2. 服务降级、服务熔断、请求限流；（万金油答案）
    2. 过期时间按加上随机值。

#### 5.3 缓存击穿

* **现象：**少量的缓存热点key失效了，大量请求直接访问数据库；
* **原因：**热点key的过期时间太短；
* **解决方案：**
    1. 增加key的过期时间，重要的key可以设置永久有效；
    2. 使用分布式锁，只允许一个请求访问数据库，其他的等待

### 6.主从复制

<img src="/assets/imgs/architect/database/redis-主从复制.png">

主从复制步骤如下：

1. slave节点连接master节点，并发送SYNC命令；
2. master节点收到SYNC命令后，fork一个子进程执行BGSAVE生成RDB文件，同时会使用一个缓冲区记录从现在开始的所有写命令；
3. master 将生成的 RDB 文件发送给 slave
4. slave 接收 RDB 文件，并载入到内存，将数据库状态更新至 master 执行 BGSAVE 时的数据库状态；
5. master 将记录在缓冲区里面的所有写命令发送给 slave；
6. slave 执行这些命令，将数据库状态更新至 master 当前所处的状态。

### 7.哨兵集群

当主服务器宕机后，需要手动把一台从服务器切换为主服务器，这就需要人工干预，费事费力，还会造成一段时间内服务不可用。这不是一种推荐的方式，更多时候，我们优先考虑哨兵模式。

哨兵模式的原理时通过发送命令，等待Redis服务器响应，从而监控Redis实例的运行状态；为防止哨兵宕机，可以组建哨兵集群。

哨兵集群主要负责以下内容：

<img src="/assets/imgs/architect/database/哨兵集群.png">

### 8.切片

<img src="/assets/imgs/architect/database/redis-切片.png">
