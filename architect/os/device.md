## 设备管理

### 1.基本概念

**设备**是计算机与外界交互的工具，主要负责输入与输出相关的工作，也称为外设。<br/>
**设备管理**的主要目标是提高设备利用率、为用户提供简单易操作且统一的界面。<br/>**主要的技术有**：<mark>中断技术、DMA技术、通道技术和缓冲技术</mark>

1. **中断技术**：在CPU执行程序的过程中，可以接收其他时间的中断请求，CPU则将当前程序执行要用到的寄存器原内容压栈保存，并停止当前正在执行的程序转而为该事件提供服务；待事件服务结束后从栈中恢复寄存器内容继续执行原来的程序。

<img src="/assets/imgs/architect/os/device/中断技术.png">

2. **DMA技术**：直接内存访问技术，I/O设备和内存进行数据交互不必再通过CPU，而是直接交由DMA控制器处理。这样并实现了与CPU间的完全并行(CPU和DMA还是要交互的)，大大提高了效率。

<img src="/assets/imgs/architect/os/device/DMA.png">

3. **缓冲技术**：为了解决CPU的速度跟I/O设备间的传输速度不匹配，提高CPU的运行效率，在CPU和外设之间增加缓冲，这样CPU可以把输出的数据快速的放入缓冲中，转而继续做其他工作；I/O设备也可以根据自己的速度从缓冲中取出数据。

<img src="/assets/imgs/architect/os/device/缓冲技术.png">

[例题：]{color:red;font-weight:bold}<p>
*某计算机系统采用双缓冲的工作方式，其工作过程如下图所示。<br/>假设：磁盘板块与缓冲区大小相同，每个磁盘块读入缓冲区的时间为10us，缓冲区到用户区的时间为6us，系统对每个磁盘块的处理时间为2us，那么，<br/>1. 10个磁盘块大小的Doc文件读取并执行，双缓冲需要花费的时间为()us;<br/>2. 比单缓冲节省了()us?*

<img src="/assets/imgs/architect/os/device/双缓冲.png">

[解：]{color:red;font-weight:bold}
1. 第一个磁盘块 --> 缓冲区 --> 用户区 ---> 执行，耗费 10 + 6 + 2 = 18us；<br/>第二个磁盘块在第一个磁盘块放入到缓冲区之后便可以开始，等到第一个磁盘块执行完，第二个磁盘块已经王缓冲区2中写入8us，还需要（10-8） + 6 + 2即可执行完；<br/>由第二步可知，从第二块以后的每个磁盘块的总耗费时间都为：（10-8） + 6 + 2 = 10us。<br/>因此：双缓冲花费时间为：18 + （10 - 1）* 10 = 108us
2. 单缓冲区形况下，第二个磁盘块王缓冲区中写入需要等到第一步缓冲区内的数据完全写入到用户区，只有执行时的2us并行，因此单缓冲耗费时间为：18 + (8 + 6 + 2) * 9 = 162us;<br/>双缓冲比单缓冲节省：162 - 108 = 54us

### 2.磁盘调度算法

在学习磁盘调度算法之前，先大体说明一下磁盘存储器的大体结构。

磁盘存储器一般由组合臂、主轴、读写头、盘面组成，盘面又分磁道，磁道分有扇区，扇区用来存储数据。

<img src="/assets/imgs/architect/os/device/磁盘结构.png">

磁盘存储器的**存储容量 = 磁盘面数 x 每面的磁道数 x 每道扇区 x 每个扇区存储字节数**<br/>硬盘的**存取时间 = 寻道时间 + 等待时间 +读/写时间**。

磁盘是共享设备，当被多个进程请求访问时，为了保证信息的安全，系统在每一时刻<mark>只允许一个进程启动磁盘进行I/O操作，其余进程只能等待。</mark>因此，必须有一种适当的调度算法，使得各进程对磁盘的平均访问时间最小。

自盘的调度算法有许多，比如：**FCFS（先来先服务）、SSTF（最短寻道时间优先）、SCAN（电梯算法）等**，架构师的考试仅局限于最短寻道时间优先算法，所以我们详细说一下SSTF。

磁盘的调度分为**移臂调度** 和 **旋转调度**，并且是先进行移臂调度，后进行旋转调度。访问磁盘最耗时的便是寻道时间，因此最短寻道时间便是基于此被提出的。

[例题1：]{color:red}<p>在磁盘调度管理中，假设磁盘移动臂现位于21号柱面，进程的请求序列如下图所示，那么系统的响应顺序为：()

|请求序列|柱面号|磁头号|扇区号|
|-|-|-|-|
|一|17||8|9|
|二|23|6|3|
|三|23|9|6|
|四|32|10|5|
|五|17|8|4|
|六|32|3|10|
|七|17|7|9|
|八|23|9|4|
|九|38|13|8|

[解：]{color:red}
* 当前移臂位于21号柱面，按照最短寻道优先，21号柱面到23号柱面最近，23号柱面上的请求序列分别是二、三和八；
* 磁头号不要考虑，柱面号相同，扇区号从小到大排序即可（在考试的角度扇区号相同哪个在前在后无所谓）

因此，答案为：二、八、三、五、一、七、六、九

---

[例题2：]{color:red}<p>
在磁盘上存储数据的排列方式会影响 I/O 服务的总时间。假设每磁道划 分成 10 个物理块，每块存放 1 个逻辑记录。逻辑记录 RI.R2， ...， RI0存放在同一个磁道上， 记录的安排顺序如下表所示;

<img src="/assets/imgs/architect/os/device/磁盘存储题-1.jpg">

假定磁盘的旋转速度为 30ms/周，磁头当前处在 R1 的开始处。若系统顺 序处理这些记录，使用单缓冲区，每个记录处理时间为 6ms，则处理这 10 个记录的**最长时间**为 （） ;若对信息**存储进行优化分布**后，处理 10 个 记录的**最少时间**为（）

<span style="color:red">**解**：</span> 

<img src="/assets/imgs/architect/os/device/磁盘存储题-2.png">

1. 磁头初始位置如图所示，读取一条指令的时间 = 30ms / 10 = 3ms，处理一条指令耗时6ms，在处理完R1后，磁头位置如图所示(R1处理完)，此时耗时3ms(读) + 6ms(执行) = 9ms；

   如果开始处理R2，磁头需要从当前位置（R1处理完）空转到R2执行开始处，耗时8 x 3ms = 24ms，因此处理完R1并回到R2的开始位置总耗时 24ms + 9ms = 33ms；

   从R1...R9的耗时 = 33ms x 9 = 297ms，R10读取和执行也需要9ms，因此总耗时 = 297ms + 9ms = 306ms

<img src="/assets/imgs/architect/os/device/磁盘存储题-3.png">

2. 假设从新排了顺序使得每次处理完磁头所在位置刚好是下一个要执行的指令，由第一问可知，一条指令完整的执行时间为9ms，10条则为90ms