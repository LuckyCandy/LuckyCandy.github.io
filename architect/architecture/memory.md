## 内部存储

**存储器的结构如下所示：**

<img src="/assets/imgs/architect/architecture/storage/存储器结构.png">

<mark>越往上，存储速度越快，价格越昂贵；越往下存储速度越慢，更廉价。</mark>

### 1. 寄存器

寄存器是CPU内部的组成单元，它是一个高速的存储部件，可用来暂存指令、数据和地址。<br/>CPU控制部件中包含的寄存器主要有：指令寄存器(IR)、程序计数器(PC);<br/>CPU的算数逻辑部件中包含的寄存器有累加器(ACC)

### 2. 高速缓存
计算机在运行程序时，首先将程序从磁盘读取到主存，然后CPU按规则从主存中取出指令，数据并执行指令，但是直接从主存（一般是DRAM）中读写是很慢的，所以引入了高速缓存来提高性能。

<img src="/assets/imgs/architect/architecture/storage/CPU-缓存-内存之间的关系.jpg">

#### 2.1 缓存的命中

在程序运行前首先会试图将指令，数据从主存中读取到Cache中，然后在程序执行时直接访问Cache。如果指令和数据可以从Cache中读取到，那么就说是“命中（hit）”，反之就是“不命中（miss）”，miss情况下需要从主存中读取指令或者数据，这样会直接影响CPU的性能，所以命中率对CPU来说至关重要。

<img src="/assets/imgs/architect/architecture/storage/Cache命中.png">

上图演示缓存的工作原理，其中<mark>主存与Cache地址映射机构</mark> 和 <mark>Cache替换机构</mark>是其工作的核心。

#### 2.2 地址映射变换

地址映射变换解决了主存和Cache块号不一致，因为有可能主存与Cache采用不同的分区策略，同时也增加了Cache的灵活性，可记录主存所有块号的任何为内容。

Cache的映射方式主要有以下几种：

1. **直接映射**：直接映射主存的页到Cache页，不灵活，块(页)冲突率较高；
2. **全相连映像**：主存中的页可以映射到任何Cache中的页，灵活性高，但无法从主存块号中直接获取Cache的块号，需要增加额外映射；
3. **组相连映像**：主存分区、分组，组内使用直接映射，组间使用全相连映像。

***使用：距离CPU较近的可使用直接或组相连映像，距离较远的可使用全相连映射***

#### 2.3 Cache替换

因为缓存的容量较小，必然会有内存内容的换进和换出。这就会遵循局部性原理，即**时间局部性**、**空间局部性**
* **时间局部性**：某段时间内会重复使用的内容不换出
* **空间局部性**：与使用中内容空间联系紧密的不换出

具体的主要有以下几种策略：
1. **随机算法**：当cache满时，随机选择一块替换掉
2. **先进先出（FIFO）**：按进入cache的先后顺序，先进的优先被替换
3. **近期最少使用（LRU）**：优先替换近期最少使用的块
4. **最不经常使用（LFU）**：优先替换最不经常使用的块

#### 2.4 缓存一致性

既然增加了缓存，必然引入了缓存与主存一致性的问题。该问题主要有以下几种解决策略：
1. **写回策略**：CPU对cache写命中时，只修改cache的内容不立即写入主存，只有当此行被换出时才写入主存。
2. **写直达策略**：又称写全或写透策略，cache写命中时，同时修改主存
3. **标记策略**：cache换进时有效标记为1，CPU对cache写命中时，只写入主存并将cache标志位置0；当要从cache读取数据，发现cache标志位为0则直接从主存读取



**相关的计算题目：**
例：内存按<mark>字节</mark>编址,地址从A4000H到CBFFFH，问：
1. 共有多少字节？
2. 用存储容量为32Kx8bit的存储芯片组成改内存，至少需要多少片？

[分析：]{color:red}
1. 按字节编址，一个地址有8位(1Byte = 8bit)，只需要计算地址从A4000H到CBFFFH可表示多少地址即可得到字节(按字节编址，一个地址就是一字节)。需要注意一个细节，<mark>从0到9是10个数字，在计算时不要忘记+1</mark>，即：CBFFF - A4000 + 1， 得到的结果转化为十进制结果即可；
2. 32Kx8bit的存储芯片，一个的容量就是32K，结合1问中所得答案，相除有余数+1

[解：]{color:red}
1. CBFFF - A4000 + 1 = (CBFFF + 1) - A4000 = CC000 - A4000 = 28000 = 2 * 16^4 + 8 * 16^3，<br/>为了计算简便，我们转换成KB(结果除以1024，也就是2^10)<br/>
(2 * 16^4 + 8 * 16^3) / 2^10 = (2^17 + 2^15) / 2^10 = 2^7 + 2^5 = 160K
2. 160K / 32K = 5







