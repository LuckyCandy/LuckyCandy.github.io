## 缓存
### 1.分布式数据库缓存

分布式数据库缓存是指在高并发环境下，为了减轻数据库压力和提高系统响应时间，在数据库和应用系统之间增加独立的缓存系统。

### 2.Memcache与Redis比较
||Memcache|Redis|
|-|-|-|
|数据类型|简单K-V结构|k-v、list、set、hash、zset|
|持久性|不支持|支持|
|分布式存储|支持|多种方式，主从、sentinel、cluster等|
|多线程支持|支持|不支持|
|内存管理|支持|无|
|事务支持|弱支持，只能保证事务中的每个操作连续执行|有限支持|

### 3.缓存淘汰策略

<img src="/assets/imgs/architect/case/cache过期策略.png" />

兜底淘汰策略：

<img src="/assets/imgs/architect/case/cache过期策略2.png">

### 4.Redis分布式存储方案

#### 4.1 主从模式

为了避免单节点故障和读写不分离的问题，Redis提供了复制功能实现master数据库中的数据更新后，会自动将更新的数据同步到其他slave数据库上。

同步又分为：<mark>全量同步</mark>和<mark>增量同步</mark>。

**全量同步：**

<img src="/assets/imgs/architect/case/redis主从复制.png">

1. 从服务器连接主服务器，发送SYNC命令；
2. 主服务器接收到SYNC命名后，开始执行BGSAVE命令生成RDB文件并使用缓冲区记录此后执行的所有写命令；
3. 主服务器BGSAVE执行完后，向所有从服务器发送快照文件，并在发送期间继续记录被执行的写命令；
4. 从服务器收到快照文件后丢弃所有旧数据，载入收到的快照；
5. 主服务器快照发送完毕后开始向从服务器发送缓冲区中的写命令；
6. 从服务器完成对快照的载入，开始接收命令请求，并执行来自主服务器缓冲区的写命令；

**增量同步：**

Redis增量复制是指Slave初始化后开始正常工作时主服务器发生的写操作同步到从服务器的过程。 增量复制的过程主要是主服务器每执行一个写命令就会向从服务器发送相同的写命令，从服务器接收并执行收到的写命令。

#### 4.2 哨兵模式
使用sentinel监控redis主从服务器，并在主服务器下线时自动进行故障转移。

三个特性：
1. 监控。Sentinel会不断的检查主服务器和从服务器的运行状态；
2. 提醒。当某个Redis服务出现问题是，Sentinel可以通过API向管理员或其他应用程序发送通知；
3. 自动故障迁移。

**主从复制和哨兵模式都没有解决master写压力的问题**

#### 4.3 集群模式

cluster模式主要包括：客户端分片、代理分片和服务分片。

1. 客户端分片

是指部署多个Redis节点，具体如何使用这些节点，主要工作在客户端。

客户端需要通过固定的Hash算法，针对不同的key计算出对应的Hash值，然后找到不同的redis节点进行读写。

迁移或者变更节点数量，可能会对业务产生影响，后来便产生了一致性哈希算法。

2. 代理分片

将分片功能交给专门的代理程序来进行。代理程序收到来自业务程序的数据请求时，根据路由规则，将这些i请求分发给正确的redis实例。

常见的代理分片产品有：Twemproxy、Codis

3. 服务端分片

采用中间加一层Proxy，有中间层决定业务数据应该要访问的Redis实例节点。

4. redis cluster

Redis Cluster没有使用中间的Proxy代理层，而是把请求转发逻辑一部分放在客户端，一部分放在了服务端，它们之间互相配合完成请求的处理。