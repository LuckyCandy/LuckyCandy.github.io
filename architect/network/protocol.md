## 网络协议

### 1.七层模型/四层模型

#### 1.1 七层模型

@info 七层模型是指开放系统互连参考模型（Open System Interconnect），是由<mark>国际标准化组织</mark>(International Organization for Standardization，ISO)提出的，是计算机或者通信系统间互联的标准。

从上到下可分为七层，**每一层都完成特定的功能，并为上一层提供服务，并使用下层所提供的服务。**

<img src="/assets/imgs/architect/network/OSI七层模型.png">

**七层主要负责的功能：**
7. 应用层(Application)：为操作系统或应用程序提供网络服务；
6、表示层(Presentation)：将信息表示为一定形式和格式的数据流；
5、会话层(Session)：通信主机间的会话建立、管理和拆除；
4、传输层(Transport)：通信主机端到端的连接；
3、网络层(Network)：将分组从源机送达到目标机，包括寻址和最优路径选择等；
2、链路层(Data Link)：提供可靠的帧传递，实现差错控制、流控等；
1、物理层(Physical)：提供透明的比特流(01流)传递

#### 1.2 TCP/IP四层模型

@info TCP/IP(Transmission Control Protocol/Internet Protocol，传输控制协议/网际协议)是指能够在多个不同网络间实现信息传输的协议簇。

**并非只有TCP和IP两个协议，而是指一个由FTP、SMTP、TCP、UDP、IP等协议构成的协议簇**，只是因为在TCP/IP协议中TCP和IP协议最具有代表性，才被称为TCP/IP协议。

<img src="/assets/imgs/architect/network/四层模型.png">

### 2.应用层协议

* **FTP：**文件传输协议(File TransportProtocol)，是网络上两台计算机传送文件的协议，运行在TCP之上。<br/>其传输模式包括：Bin(二进制)和ASCII(文本文件)两种。<br/>FTP在客户机和服务器之间需要建立两条TCP连接，一条用于传送控制信息(使用<mark>21号端口</mark>)，另一条用于传送文件内容(使用<mark>20号端口</mark>)

* **TFTP：**简单文件传输协议(Trivial FileTransfer Protocol)用来在客户机和服务器之间进行简单文件传输的协议，提供不复杂、开销不大、不可靠的文件传输服务。<br/>建立在 **UDP**之上，<mark>端口号69</mark>

* **HTTP：**超文本传输协议(Hypertext Transfer Protocol)用于从WWW服务器传输超文本到本地浏览器的传送协议。<br/>建立在<mark>TCP之上，端口号是80</mark>。

* **HTTPS：**是以安全为目标的HTTP通道，在HTTP的基础上加入了SSL，使用443端口

* **DHCP：**动态主机配置协议(Dynamic Host Configuration Protocol)，主要用来管理、分配IP地址，使网络环境中的主机能够动态获取IP地址、网关地址、DNS服务器地址等信息。<br/>客户端通过向DHCP服务器发送请求(DHCP-DISCOVER)，根据收到的第一个Offer报文返回REQUEST报文,得到DHCP服务器的ACK确认。

* **DNS：**域名系统(Domain Name System)把主机的域名解析成IP的系统。DNS查询过程涉及两种方式：
1. 迭代查询：查询得到的是其他服务器的引用，需要访问引用服务器，做进一步查询；
2. 递归查询：要求服务器彻底地进行解析，返回最后的结果。

区别这两种查询，主要<mark>看返回的是服务器的引用还是结果，如果是前者则为迭代查询，否则为递归查询。</mark>

### 3.传输层协议

传输层协议这里只介绍两个比较重要的：**TCP、UDP**，对比来看：

|TCP|UDP|
|:---:|:---:|
|可靠的、面向连接的、字节流服务|不可靠的、无连接的、面向报文|
|首部开销：20字节|首部开销：8字节|
|具有差错校验、重传、流量控制、拥塞控制功能，适合数据量较少，对可靠性要求较高的场合|适合数据量大，对可靠性要求不高，但速度要求快的场合|

### 4.网络层协议

* **IPV4：**互联网通信协议第四版(Internet Protocol version 4)，是一种**无连接**的协议，操作在使用分组交换的链路层上。

<img src="/assets/imgs/architect/network/IPV4.png">

1. **版本（Version）**：
本字段占4bit，表示所使用的网络层IP协议的版本号。通信双方使用的版本必须一致。字段的值是4，表示IPv4，字段的值是6，表示IPv6。

2. **首部长度（Internet Header Length， IHL）**：
首部长度占4bit，首部长度说明首部有多少32位字（4字节）。因为一个IPv4 数据报可包含一些可变数量的选项，这个字段也用来确定数据的偏移量。这个字段的最小值为5（二进制0101），相当于5*4=20字节（RFC 791），最大十进制值是15。

3. **区分服务（Differentiated Services，DS）**：
在首部长度字段后，最早的RFV0791规定了一个长度为8bit的服务类型（ToS），ToS字段用了4位：D（延迟）、T（吞吐量）、R（可靠性）、C（成本）。但是ToS字段在路由器中并没有很好地利用起来。

1998年RFC2474、RFC3168、RFC3260重新定义了这个长度为8bit的字段，前6bit定义为服务类型字段，后2bit为显式拥塞通告。只有在使用区分服务时，这个字段才起作用，在一般的情况下都不使用这个字段。例如需要实时数据流的技术会应用这个字段，一个例子是VoIP。

* 服务类型(TOS）包含在IPv4首部中，以便使不同类型的IP数据报（例如，一些特别要求低时延、高吞吐量或可靠性的数据报）能相互区别开来。例如，将实时数据报（如用于IP电话应用)与非实时流量（如FTP)区分开也许是有用的。提供特定等级的服务是一个由网络管理员对路由器确定和配置的策略问题。

* 显式拥塞通告（ Explicit Congestion Notification，ECN）在RFC 3168中定义，允许在不丢弃报文的同时通知对方网络拥塞的发生。ECN是一种可选的功能，仅当两端都支持并希望使用，且底层网络支持时才被使用。

4. **全长（Total Length）**：
这是IP数据报的总长度（首部加上数据)，以字节计。因为该字段长为16比特，所以IP数据报的理论最大长度为65535字节。然而，数据报很少有超过1500字节的，该长度使得IP数据报能容纳最大长度以太网帧的载荷字段。当下层的数据链路协议的最大传输单元（MTU）字段的值小于IP报文长度时，报文就必须被分片。

标识符（Identification）、标志（Flags）、片偏移（Fragment Offset）。这三个字段与所谓IP分片有关。有趣的是，新版本的IP(即 IPv6）不允许在路由器上对分组分片。

5. **存活时间（Time To Live，TTL）**：
这个8位字段避免报文在互联网中永远存在（例如陷入路由环路）。存活时间以秒为单位，但小于一秒的时间均向上取整到一秒。在现实中，这实际上成了一个跳数计数器：报文经过的每个路由器都将此字段减1，当此字段等于0时，报文不再向下一跳传送并被丢弃，最大值是255。常规地，一份ICMP报文被发回报文发送端说明其发送的报文已被丢弃。这也是traceroute的核心原理。

6. **协议 （Protocol）**：
占8bit，这个字段定义了该报文数据区使用的协议。IANA维护着一份协议列表（最初由RFC 790定义），详细参见IP协议号列表。

7. **首部检验和 （Header Checksum）**：
这个16位检验和字段只对首部查错，不包括数据部分。在每一跳，路由器都要重新计算出的首部检验和并与此字段进行比对，如果不一致，此报文将会被丢弃。重新计算的必要性是因为每一跳的一些首部字段（如TTL、Flag、Offset等）都有可能发生变化，不检查数据部分是为了减少工作量。数据区的错误留待上层协议处理——用户数据报协议（UDP）和传输控制协议（TCP）都有检验和字段。此处的检验计算方法不使用CRC。RFC 1071

8. **地址（Address）**：
地址字段包括源地址与目的地址。

* 源地址（Source address）：一个IPv4地址由四个字节共32位构成，此字段的值是将每个字节转为二进制并拼在一起所得到的32位值。例如，10.9.8.7是00001010000010010000100000000111。但请注意，因为NAT的存在，这个地址并不总是报文的真实发送端，因此发往此地址的报文会被送往NAT设备，并由它被翻译为真实的地址。

* 目的地址（Destination address）：与源地址格式相同，但指出报文的接收端。

9. **选项（Options）**：
选项字段允许IP首部被扩展。首部选项意味着很少使用，因此决定对每个数据报首部不包括选项字段中的信息，这样能够节约开销。然而，少量选项的存在的确使问题复杂了，因为数据报首部长度可变，故不能预先确定数据字段从何处开始。而且还因为有些数据报要求处理选项，而有些数据报则不要求，故导致一台路由器处理一个IP数据报所需的时间变化可能很大。这些考虑对于高性能路由器和主机上的IP处理来说特别重要。

* **IPV6：**IPv6（Internet Protocol Version 6，互联网协议版本6）是网络层协议的第二代标准协议，也被称为IPng（IP Next Generation，下一代互联网协议）。IPv6地址的长度是128比特（16字节），可以提供超过3.4×1038个地址。在万物互联的需求下，IPv6具有足够大的地址空间，可以为每一个具有联网需求的终端提供IPv6地址，而不用担心地址耗尽，极大地增强了互联网的服务能力。

<img src="/assets/imgs/architect/network/IPV6.png">

1. **版本（Version）**：4 bit，值为 6（二进制值为 0110）表示 IPv6 报文。
2. **流量类别（Traffic Class）**：8 bit，这相当于 IPv4 协议中的 ToS 字段。但是，考虑到 ToS 字段这些年的发展，现在都用来做区分服务等级（Differentiated Class of Service，DiffServ）了。所以，即使这个字段和旧的 ToS 字段有些相似，它们的名字要比所传送的值更能确切地反映目前的用处。
3. **流标签（Flow Label）**：20 bit，IPv6 中新增。流标签可用来标记特定流的报文，以便在网络层区分不同的报文。转发路径上的路由器可以根据流标签来区分流并进行处理。由于流标签在 IPv6 报文头中携带，转发路由器可以不必根据报文内容来识别不同的流，目的节点也同样可以根据流标签识别流，同时由于流标签在报文头中，因此使用 IPSec 后仍然可以根据流标签进行 QoS 处理。
4. **有效载荷长度（Payload Length）**：16 bit，以字节为单位的 IPv6 载荷长度，也就是 IPv6 报文基本头以后部分的长度（包括所有扩展头部分）。IPv4 的总长度字段是 16 位的，但 IPv6 的有效载荷长度字段却是 20 位，这就意味着该字段能够指定更长的有效载荷（1 048 575 字节，相对 IPv4 中只有 65 535 字节）（本句源自《 TCP / IP 路由技术 》，有误）。
5. **下一报头（Next Header）**：8 bit，用来标识当前头（基本头或扩展头）后下一个头的类型。此域内定义的类型与 IPv4 中的协议域值相同。IPv6 定义的扩展头由基本头或扩展头中的扩展头域链接成一条链。这一机制下处理扩展头更高效，转发路由器只处理必须处理的选项头，提高了转发效率。
6. **跳数限制（Hop Limit）**：8 bit，和 IPv4 中的 TTL 字段类似。每个转发此报文的节点把此域减 1，如果此域值减到 0 则丢弃。注意：IPv4 中的 TTL 设计之初是以秒（s）为单位的，但实际使用时跟 IPv6 中的 Hop Limit 一样，是以跳数为单位。
7. **源地址（Source Address）**：128 bit，报文的源地址。
8. **目的地址（Destination Address）**：128 bit，报文的目的地址。<br/>
(1) 单播：点对点通信；<br/>
(2）组播：一对多通信；<br/>
(3）任播：新增类型，一对最近

**从IPv4到IPv6过度技术有：**
1. 双协议栈技术：两种协议共存；
2. 隧道技术：在IPv4网络中部署隧道；
3. NAT-PT技术：NAT-PT网关实现两种协议的转换翻译和地址的映射